<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<parent>
		<groupId>org.openlca</groupId>
		<artifactId>olca-modules</artifactId>
		<version>2.6.0</version>
	</parent>
	<artifactId>olca-core</artifactId>
	<packaging>jar</packaging>
	<name>${project.groupId}:${project.artifactId}</name>

	<properties>
		<protobuf.version>4.33.0</protobuf.version>
	</properties>

	<dependencies>

		<dependency>
			<groupId>org.eclipse.persistence</groupId>
			<artifactId>org.eclipse.persistence.jpa</artifactId>
			<version>4.0.8</version>
		</dependency>

		<dependency>
			<groupId>org.apache.commons</groupId>
			<artifactId>commons-math3</artifactId>
			<version>3.6.1</version>
		</dependency>

		<dependency>
			<groupId>org.openlca</groupId>
			<artifactId>olca-formula</artifactId>
			<version>2.0.0</version>
		</dependency>

		<dependency>
			<groupId>org.openlca</groupId>
			<artifactId>npy</artifactId>
			<version>0.0.3</version>
		</dependency>

		<dependency>
			<groupId>org.openlca</groupId>
			<artifactId>olca-native</artifactId>
			<version>0.0.2</version>
		</dependency>

		<dependency>
			<groupId>org.apache.derby</groupId>
			<artifactId>derby</artifactId>
			<version>10.17.1.0</version>
		</dependency>

		<dependency>
			<groupId>com.google.guava</groupId>
			<artifactId>guava</artifactId>
			<version>33.5.0-jre</version>
		</dependency>

		<dependency>
			<groupId>com.zaxxer</groupId>
			<artifactId>HikariCP</artifactId>
			<version>7.0.2</version>
		</dependency>

		<dependency>
			<groupId>net.sf.trove4j</groupId>
			<artifactId>trove4j</artifactId>
			<version>3.0.3</version>
		</dependency>

		<dependency>
			<groupId>org.locationtech.jts</groupId>
      <artifactId>jts-core</artifactId>
      <version>1.20.0</version>
		</dependency>

		<dependency>
			<groupId>com.google.code.gson</groupId>
			<artifactId>gson</artifactId>
			<version>2.13.2</version>
		</dependency>

		<dependency>
			<groupId>org.apache.commons</groupId>
			<artifactId>commons-csv</artifactId>
			<version>1.14.1</version>
		</dependency>

		<dependency>
			<groupId>com.google.protobuf</groupId>
			<artifactId>protobuf-java</artifactId>
			<version>${protobuf.version}</version>
		</dependency>

		<dependency>
			<groupId>com.google.protobuf</groupId>
			<artifactId>protobuf-java-util</artifactId>
			<version>${protobuf.version}</version>
		</dependency>

	</dependencies>
	<repositories>
		<repository>
			<id>maven_central</id>
			<name>Maven Central</name>
			<url>https://repo.maven.apache.org/maven2/</url>
		</repository>
	</repositories>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<version>3.13.0</version>
				<configuration>
					<release>21</release>
					<compilerArgs>
						<arg>--enable-preview</arg>
					</compilerArgs>
				</configuration>
			</plugin>

			<!-- OS detection plugin -->
			<plugin>
				<groupId>kr.motd.maven</groupId>
				<artifactId>os-maven-plugin</artifactId>
				<version>1.7.1</version>
				<executions>
					<execution>
						<phase>initialize</phase>
						<goals>
							<goal>detect</goal>
						</goals>
					</execution>
				</executions>
			</plugin>

			<!-- Native compilation using Ant - only on macOS ARM64 -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-antrun-plugin</artifactId>
				<version>3.1.0</version>
				<executions>
					<execution>
						<id>compile-native</id>
						<phase>compile</phase>
						<goals>
							<goal>run</goal>
						</goals>
						<configuration>
							<target>
								<property name="srcFile" value="${project.basedir}/src/main/c/accelerate_sparse_wrapper.c"/>
								<property name="outputDir" value="${project.build.directory}/native/${os.detected.classifier}"/>
								<property name="outputFile" value="${outputDir}/libaccelerate_sparse_wrapper.dylib"/>
								
								<mkdir dir="${outputDir}"/>
								
								<!-- Delete old library to ensure fresh build -->
								<delete file="${outputFile}" failonerror="false" quiet="true"/>
								
								<echo message="Compiling native library: ${outputFile}"/>
								
								<exec executable="gcc" failonerror="true">
									<arg value="-shared"/>
									<arg value="-fPIC"/>
									<arg value="-arch"/>
									<arg value="arm64"/>
									<arg value="-std=c11"/>
									<arg value="-g"/>
									<arg value="-O0"/>
									<arg value="-Wall"/>
									<arg value="-Wextra"/>
									<arg value="-fvisibility=default"/>
									<arg value="-Wl,-flat_namespace"/>
									<arg value="-Wl,-undefined,dynamic_lookup"/>
									<arg value="-install_name"/>
									<arg value="@rpath/libaccelerate_sparse_wrapper.dylib"/>
									<arg value="-o"/>
									<arg value="${outputFile}"/>
									<arg value="${srcFile}"/>
									<arg value="-framework"/>
									<arg value="Accelerate"/>
								</exec>
								
								<echo message="Native library compiled successfully"/>
							</target>
						</configuration>
					</execution>
				</executions>
			</plugin>

			<!-- Copy native library to resources - ensure osx-aarch64 is always available on macOS -->
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-antrun-plugin</artifactId>
				<version>3.1.0</version>
				<executions>
					<execution>
						<id>copy-native-lib</id>
						<phase>compile</phase>
						<goals>
							<goal>run</goal>
						</goals>
						<configuration>
							<target>
								<!-- Copy from detected classifier directory -->
								<property name="srcLib" 
								          value="${project.build.directory}/native/${os.detected.classifier}/libaccelerate_sparse_wrapper.dylib"/>
								<property name="destDir" 
								          value="${project.build.directory}/classes/native/${os.detected.classifier}"/>
								
								<mkdir dir="${destDir}"/>
								
								<!-- Copy library using fileset (only copies if file exists) -->
								<copy todir="${destDir}" failonerror="false" verbose="false" quiet="true">
									<fileset file="${srcLib}" erroronmissingdir="false"/>
								</copy>
								
								<!-- On macOS, also always copy to osx-aarch64 if the library exists -->
								<!-- This ensures the library is available even if os.detected.classifier is wrong -->
								<property name="aarch64DestDir" 
								          value="${project.build.directory}/classes/native/osx-aarch64"/>
								<mkdir dir="${aarch64DestDir}"/>
								<copy todir="${aarch64DestDir}" failonerror="false" verbose="false" quiet="true">
									<fileset file="${srcLib}" erroronmissingdir="false"/>
								</copy>
								
								<!-- Log status -->
								<echo message="Native library copy step completed"/>
							</target>
						</configuration>
					</execution>
					
					<!-- Copy to install/workspace locations for development -->
					<execution>
						<id>deploy-native-lib</id>
						<phase>process-classes</phase>
						<goals>
							<goal>run</goal>
						</goals>
						<configuration>
							<target>
								<property name="srcLib" 
								          value="${project.build.directory}/classes/native/osx-aarch64/libaccelerate_sparse_wrapper.dylib"/>
								
								<!-- Copy to common install location (creates directory if needed) -->
								<!-- failonerror="false" means it will silently skip if source doesn't exist -->
								<property name="installDir" value="${user.home}/openLCA-data-1.4/native/osx-aarch64"/>
								<mkdir dir="${installDir}"/>
								<copy file="${srcLib}" tofile="${installDir}/libaccelerate_sparse_wrapper.dylib" 
								      failonerror="false" verbose="true" quiet="true"/>
								
								<!-- Copy to workspace root (for Eclipse development) -->
								<property name="workspaceRoot" value="${project.basedir}/../../native/osx-aarch64"/>
								<mkdir dir="${workspaceRoot}"/>
								<copy file="${srcLib}" tofile="${workspaceRoot}/libaccelerate_sparse_wrapper.dylib" 
								      failonerror="false" verbose="true" quiet="true"/>
								
								<echo message="Native library deployment step completed"/>
							</target>
						</configuration>
					</execution>
				</executions>
			</plugin>
		</plugins>
	</build>

</project>
